name: Issue Dataset to Pull Request

on:
  issues:
    types: [opened]

jobs:
  run-script:
    if: contains(github.event.issue.labels.*.name, 'new_dataset')
    runs-on: ubuntu-latest

    steps:
    - name: "[ISSUE] Issue notification of start of processing"
      uses: actions/github-script@v7.0.1
      with:
        script: |
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: 'Your request is being processed...'
          })

    - name: "[GIT] Clone the repository into the GitHub Actions"
      uses: actions/checkout@v4.2.2
    
    # - name: "[GIT] Create develop branch if it does not exist"
    #   run: |
    #     git fetch origin
    #     if ! git rev-parse --verify origin/develop; then
    #       git checkout -b develop origin/main
    #       git push origin develop
    #     else
    #       git checkout develop
    #     fi
    
    - name: "[GIT] Create temporary branch"
      id: create_temp_branch
      run: |
        TEMP_BRANCH="request_new_dataset/branch-issue-${{ github.event.issue.number }}"
        echo "TEMP_BRANCH=$TEMP_BRANCH" >> $GITHUB_ENV
        git checkout -b $TEMP_BRANCH
        git push --set-upstream origin $TEMP_BRANCH

    - name: "[TASK] Set up Python"
      uses: actions/setup-python@v5.3.0
      with:
        python-version: '3.12.1'

    - name: "[TASK] Install dependencies"
      run: |
        python -m pip install --upgrade pip
        pip install -r .github/workflows/issue_dataset_to_pr/requirements.txt
        pip install -r scripts/csv_to_markdown/requirements.txt

    - name: "[TASK] Run the Python script"
      run: |
        python .github/workflows/issue_dataset_to_pr/main.py 2>error.log
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        PYTHONPATH: ${{ github.workspace }}
    
    - name: "[ISSUE] Comment on Issue if Error"
      if: ${{ failure() }}
      uses: actions/github-script@v7.0.1
      with:
        script: |
          const fs = require('fs');
          const errorLog = fs.readFileSync('error.log', 'utf8');
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `An error occurred while processing the issue:\n\n\`\`\`\n${errorLog}\`\`\``
          });

    - name: "[GIT] Commit and push changes"
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add .
        git commit -m "Update data catalog for issue #${{ github.event.issue.number }}"
    
    - name: "[GIT] Create Pull Request"
      uses: peter-evans/create-pull-request@v7.0.5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        base: develop
        branch: ${{ env.TEMP_BRANCH }}
        title: "[NEW DATASET]: Issue #${{ github.event.issue.number }}"
        body: "Automated changes to update the data catalog for issue #${{ github.event.issue.number }}."

    - name: "[ISSUE] Comment & Close the issue"
      uses: actions/github-script@v7.0.1
      with:
        script: |
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: 'Your request has been processed and is awaiting review and approval to be added to the data catalog.'
          })
          github.rest.issues.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            state: 'closed'
          })